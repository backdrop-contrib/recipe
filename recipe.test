<?php
/**
 * @file
 * Tests for recipe.module.
 */

/**
 * Tests the functionality of the Recipe content type.
 */
class RecipeWebTestCase extends DrupalWebTestCase {
  protected $admin_user;
  protected $unit_list;

  public function setUp() {
    // Enable modules required for testing.
    parent::setUp(array(
      'recipe',
      'recipe_plaintext',
      'recipe_html',
      'recipe_recipeML',
      'recipe_mastercook4',
      'recipe_test',
    ));

    // Create and log in the admin user with Recipe content permissions.
    $this->admin_user = $this->drupalCreateUser(array(
      'create recipe content',
      'edit any recipe content',
      'import recipes',
      'export recipes',
      'administer site configuration',
      'administer blocks',
    ));
    $this->drupalLogin($this->admin_user);

    // Populate the unit list.
    $this->unit_list = recipe_get_units();
  }
}

/**
 * Tests the functionality of the Recipe content type and Recipe blocks.
 */
class RecipeNodeTestCase extends RecipeWebTestCase {
  public static function getInfo() {
    return array(
      'name' => 'Recipe content type',
      'description' => 'Ensure that the recipe content type functions properly.',
      'group' => 'Recipe',
    );
  }

  /**
   * Creates a recipe node using the node form and test the module settings.
   */
  public function testRecipeContent() {
    // Generate values for our test node.
    $title = $this->randomName(16);
    $description = $this->randomName(255);
    $yield_unit = $this->randomName(10);
    $yield = 5;
    $source = $this->randomName(16);
    $notes = $this->randomName(255);
    $instructions = $this->randomname(255);
    $preptime = 60;
    $cooktime = 15;

    // Ingredient with quantity == 1 and unit tablespoon with note.
    $ing_0_quantity = 1;
    $ing_0_unit = 'tablespoon';
    $ing_0_name = $this->randomName(16);
    $ing_0_note = $this->randomName(16);

    // Ingredient with quantity > 1 and unit tablespoon with note.
    $ing_1_quantity = 2;
    $ing_1_unit = 'tablespoon';
    $ing_1_name = $this->randomName(16);
    $ing_1_note = $this->randomName(16);

    // Ingredient with quantity == 0 and unit tablespoon with note.
    $ing_2_quantity = 0;
    $ing_2_unit = 'tablespoon';
    $ing_2_name = $this->randomName(16);
    $ing_2_note = $this->randomName(16);

    // Ingredient without note.
    $ing_3_quantity = 1;
    $ing_3_unit = 'tablespoon';
    $ing_3_name = $this->randomName(16);
    $ing_3_note = '';

    // Ingredient with unit that has no abbreviation.
    $ing_4_quantity = 10;
    $ing_4_unit = 'unit';
    $ing_4_name = $this->randomName(16);
    $ing_4_note = $this->randomName(16);

    $edit = array(
      'title' => $title,
      'recipe_description[value]' => $description,
      'recipe_yield_unit' => $yield_unit,
      'recipe_yield' => $yield,
      'recipe_source' => $source,
      'recipe_notes[value]' => $notes,
      'recipe_instructions[value]' => $instructions,
      'recipe_preptime' => $preptime,
      'recipe_cooktime' => $cooktime,
      'recipe_ingredients[ing][0][quantity]' => $ing_0_quantity,
      'recipe_ingredients[ing][0][unit_key]' => $ing_0_unit,
      'recipe_ingredients[ing][0][name]' => $ing_0_name,
      'recipe_ingredients[ing][0][note]' => $ing_0_note,
      'recipe_ingredients[ing][1][quantity]' => $ing_1_quantity,
      'recipe_ingredients[ing][1][unit_key]' => $ing_1_unit,
      'recipe_ingredients[ing][1][name]' => $ing_1_name,
      'recipe_ingredients[ing][1][note]' => $ing_1_note,
      'recipe_ingredients[ing][2][quantity]' => $ing_2_quantity,
      'recipe_ingredients[ing][2][unit_key]' => $ing_2_unit,
      'recipe_ingredients[ing][2][name]' => $ing_2_name,
      'recipe_ingredients[ing][2][note]' => $ing_2_note,
      'recipe_ingredients[ing][3][quantity]' => $ing_3_quantity,
      'recipe_ingredients[ing][3][unit_key]' => $ing_3_unit,
      'recipe_ingredients[ing][3][name]' => $ing_3_name,
      'recipe_ingredients[ing][3][note]' => $ing_3_note,
      'recipe_ingredients[ing][4][quantity]' => $ing_4_quantity,
      'recipe_ingredients[ing][4][unit_key]' => $ing_4_unit,
      'recipe_ingredients[ing][4][name]' => $ing_4_name,
      'recipe_ingredients[ing][4][note]' => $ing_4_note,
    );

    // Post the values to the node form.
    $this->drupalPost('node/add/recipe', $edit, t('Save'));
    $this->assertText(t('Recipe @title has been created.', array('@title' => $title)));

    // Check the page for the recipe content.
    $this->assertText($description, 'Found the recipe description.');
    $this->assertFieldById('edit-custom-yield', $yield, 'Found the recipe yield in the custom yield form.');
    $this->assertText($yield_unit, 'Found the recipe yield unit.');
    $this->assertText($source, 'Found the recipe source.');
    $this->assertText($notes, 'Found the recipe notes.');
    $this->assertText($instructions, 'Found the recipe instructions');
    $this->assertText($this->formatTime($preptime), 'Found the recipe prep time.');
    $this->assertText($this->formatTime($cooktime), 'Found the recipe cook time.');
    $this->assertText($this->formatTime($preptime + $cooktime), 'Found the recipe total time.');

    $this->assertText(t('@quantity @unit', array('@quantity' => $ing_0_quantity, '@unit' => $this->unit_list[$ing_0_unit]['abbreviation'])), 'Found ingredient 0 quantity and abbreviation.');
    $this->assertText(format_string('@name (@note)', array('@name' => $ing_0_name, '@note' => $ing_0_note)), 'Found ingredient 0 name and note.');

    $this->assertText(t('@quantity @unit', array('@quantity' => $ing_1_quantity, '@unit' => $this->unit_list[$ing_1_unit]['abbreviation'])), 'Found ingredient 1 quantity and abbreviation.');
    $this->assertText(format_string('@name (@note)', array('@name' => $ing_1_name, '@note' => $ing_1_note)), 'Found ingredient 1 name and note.');

    $this->assertNoText(t('@quantity @unit', array('@quantity' => $ing_2_quantity, '@unit' => $this->unit_list[$ing_2_unit]['abbreviation'])), 'Did not find ingredient 2 quantity == 0.');
    $this->assertText(format_string('@name (@note)', array('@name' => $ing_2_name, '@note' => $ing_2_note)), 'Found ingredient 2 name and note.');

    $this->assertText(t('@quantity @unit', array('@quantity' => $ing_3_quantity, '@unit' => $this->unit_list[$ing_3_unit]['abbreviation'])), 'Found ingredient 3 quantity and abbreviation.');
    $this->assertNoText(format_string('@name (@note)', array('@name' => $ing_3_name, '@note' => $ing_3_note)), 'Did not find ingredient 3 name with blank note field, "()".');

    $this->assertRaw(format_string('<div class="quantity-unit" property="schema:amount"> @quantity </div>', array('@quantity' => $ing_4_quantity)), 'Found ingredient 4 quantity with no unit.');
    $this->assertText(format_string('@name (@note)', array('@name' => $ing_4_name, '@note' => $ing_4_note)), 'Found ingredient 4 name and note.');

    // Check the page HTML for the recipe RDF properties.
    $properties = array(
      'schema:Recipe',
      'schema:name',
      'schema:instructions',
      'schema:summary',
      'schema:prepTime',
      'schema:cookTime',
      'schema:totalTime',
      // @todo 'schema:yield' is defined in recipe_rdf_mapping(), but is not
      // currently implemented in any theme function.
      //'schema:yield',
    );
    foreach ($properties as $property) {
      $this->assertRaw($property, format_string('Found the RDF property "@property" in the recipe node HTML.', array('@property' => $property)));
    }

    // Change the Recipe module settings.
    $summary_title = $this->randomName(16);
    $edit = array(
      // Enable full unit name display.
      'recipe_unit_display' => 1,
      // Enable lowercase normalization of ingredient names.
      // @todo The ingredient name normalization setting currently does nothing.
      //'recipe_ingredient_name_normalize' => 1,
      // Hide the recipe summary.
      // @todo The recipe summary location setting currently does nothing.
      //'recipe_summary_location' => 2,
      // Change the Summary block title.
      'recipe_summary_title' => $summary_title,
    );

    // Post the values to the settings form.
    $this->drupalPost('admin/config/system/recipe', $edit, t('Save configuration'));

    // Check the recipe node display again.
    $this->drupalGet('node/1');

    $this->assertText(t('@quantity @unit', array('@quantity' => $ing_0_quantity, '@unit' => $this->unit_list[$ing_0_unit]['name'])), 'Found ingredient 0 quantity and singular unit name.');

    $this->assertText(t('@quantity @unit', array('@quantity' => $ing_1_quantity, '@unit' => $this->unit_list[$ing_1_unit]['plural'])), 'Found ingredient 1 quantity and plural unit name.');

    //$this->assertText(strtolower($ing_0_name), 'Found normalized ingredient 0 name.');
    //$this->assertText(strtolower($ing_1_name), 'Found normalized ingredient 1 name.');
    //$this->assertText(strtolower($ing_2_name), 'Found normalized ingredient 2 name.');
    //$this->assertText(strtolower($ing_3_name), 'Found normalized ingredient 3 name.');
    //$this->assertText(strtolower($ing_4_name), 'Found normalized ingredient 4 name.');

    //$this->assertNoText(t('Summary'), 'Did not find the recipe summary.');

    // Enable the Newest Recipes and Recipe Summary blocks.
    // Check for it and the node link.
    $edit = array(
      "blocks[recipe_recent][region]" => 'sidebar_first',
      "blocks[recipe_summary][region]" => 'sidebar_first',
    );
    $this->drupalPost('admin/structure/block', $edit, t('Save blocks'));
    $this->assertText(t('Newest recipes'), 'Found the Newest recipes block.');
    $this->assertLink($title, 0);
    // Make sure the Summary block doesn't appear on a non-recipe-node page.
    $this->assertNoText($summary_title, 'Did not find the altered Summary block title.');

    // Check for the Summary block on the recipe node page.
    $this->drupalGet('node/1');
    $this->assertText($summary_title, 'Found the altered Summary block title.');

    // Test ingredient autocomplete for the first ingredient.
    $input = substr($ing_0_name, 0, 3);
    $this->drupalGet('recipe/ingredient/autocomplete/' . $input);
    $this->assertRaw('{"' . $ing_0_name . '":"' . $ing_0_name . '"}', format_string('Autocomplete returns ingredient %ingredient_name after typing the first 3 letters.', array('%ingredient_name' => $ing_0_name)));

    // Test the export formats.
    // Check that the export format links are displayed on the recipe node page.
    $this->drupalGet('node/1');
    $this->assertLink('Print View', 0);
    $this->assertLink('MasterCook4', 0);
    $this->assertLink('Plain Text', 0);
    $this->assertLink('recipeML', 0);

    // Check for the recipe data on the HTML export page.
    $this->drupalGet('recipe/export/recipeprint/1/' . $yield);
    $this->assertRaw($description, 'Found the recipe description.');
    // The HTML format does not output the yield.
    // The HTML format does not output the yield unit.
    $this->assertRaw($source, 'Found the recipe source.');
    $this->assertRaw($notes, 'Found the recipe notes.');
    $this->assertRaw($instructions, 'Found the recipe instructions');
    $this->assertRaw(t('Prep time: @time', array('@time' => $this->formatHTMLTime($preptime))), 'Found the recipe prep time.');
    $this->assertRaw(t('Cooking time: @time', array('@time' => $this->formatHTMLTime($cooktime))), 'Found the recipe cook time.');
    $this->assertRaw(t('Total time: !time', array('!time' => $this->formatHTMLTime($preptime + $cooktime))), 'Found the recipe total time.');

    $this->assertRaw(format_string('@quantity @unit', array('@quantity' => $ing_0_quantity, '@unit' => $this->unit_list[$ing_0_unit]['name'])), 'Found ingredient 0 quantity and unit name.');
    $this->assertRaw(format_string('@name (@note)', array('@name' => $ing_0_name, '@note' => $ing_0_note)), 'Found ingredient 0 name and note.');

    $this->assertRaw(format_string('@quantity @unit', array('@quantity' => $ing_1_quantity, '@unit' => $this->unit_list[$ing_1_unit]['plural'])), 'Found ingredient 1 quantity and unit plural name.');
    $this->assertRaw(format_string('@name (@note)', array('@name' => $ing_1_name, '@note' => $ing_1_note)), 'Found ingredient 1 name and note.');

    $this->assertRaw(format_string('!quantity @unit', array('!quantity' => '&nbsp;', '@unit' => $this->unit_list[$ing_2_unit]['name'])), 'Found ingredient 2 unit name.');
    $this->assertRaw(format_string('@name (@note)', array('@name' => $ing_2_name, '@note' => $ing_2_note)), 'Found ingredient 2 name and note.');

    $this->assertRaw(format_string('@quantity @unit', array('@quantity' => $ing_3_quantity, '@unit' => $this->unit_list[$ing_3_unit]['name'])), 'Found ingredient 3 quantity and unit name.');
    $this->assertRaw($ing_3_name, 'Found ingredient 3 name.');

    $this->assertRaw(format_string('<div class="quantity-unit" property="schema:amount"> @quantity </div>', array('@quantity' => $ing_4_quantity)), 'Found ingredient 4 quantity and with no unit.');
    $this->assertRaw(format_string('@name (@note)', array('@name' => $ing_4_name, '@note' => $ing_4_note)), 'Found ingredient 4 name and note.');

    // Check for the recipe data on the MasterCook4 export page.
    $this->drupalGet('recipe/export/mastercook4/1/' . $yield);
    // The MasterCook4 format does not output the description.
    $this->assertRaw(format_string('Serving Size  : @yield', array('@yield' => $yield)), 'Found the recipe yield.');
    // The MasterCook4 format does not output the yield unit.
    $this->assertRaw(format_string('Recipe By     : @source', array('@source' => $source)), 'Found the recipe source.');
    $this->assertRaw($notes, 'Found the recipe notes.');
    $this->assertRaw($instructions, 'Found the recipe instructions');
    $hours = (int) ($preptime / 60);
    $minutes = $preptime % 60;
    $mastercook_time = $hours . ':' . $minutes;
    $this->assertRaw(format_string('Preparation Time :@time', array('@time' => $mastercook_time)), 'Found the recipe prep time.');
    // The MasterCook4 format does not output the cook time.
    // The MasterCook4 format does not output the total time.
    $this->assertRaw(format_string('@quantity  @unit    @name -- @note', array('@quantity' => $ing_0_quantity, '@unit' => $this->unit_list[$ing_0_unit]['name'], '@name' => $ing_0_name, '@note' => $ing_0_note)), 'Found ingredient 0.');
    $this->assertRaw(format_string('@quantity  @unit   @name -- @note', array('@quantity' => $ing_1_quantity, '@unit' => $this->unit_list[$ing_1_unit]['plural'], '@name' => $ing_1_name, '@note' => $ing_1_note)), 'Found ingredient 1.');
    $this->assertRaw(format_string('   @unit    @name -- @note', array('@unit' => $this->unit_list[$ing_2_unit]['name'], '@name' => $ing_2_name, '@note' => $ing_2_note)), 'Found ingredient 2.');
    $this->assertRaw(format_string('@quantity  @unit    @name', array('@quantity' => $ing_3_quantity, '@unit' => $this->unit_list[$ing_3_unit]['name'], '@name' => $ing_3_name)), 'Found ingredient 3.');
    $this->assertRaw(format_string('@quantity                @name -- @note', array('@quantity' => $ing_4_quantity, '@name' => $ing_4_name, '@note' => $ing_4_note)), 'Found ingredient 4.');

    // Check for the recipe data on the plain text export page.
    $this->drupalGet('recipe/export/plaintext/1/' . $yield);
    $this->assertRaw($description, 'Found the recipe description.');
    // The plain text format does not output the yield.
    // The plain text format does not output the yield unit.
    // The plain text format does not output the source.
    $this->assertRaw($notes, 'Found the recipe notes.');
    $this->assertRaw($instructions, 'Found the recipe instructions');
    // The plain text format does not output the prep time.
    // The plain text format does not output the cook time.
    // The plain text format does not output the total time.
    $this->assertRaw(format_string('@quantity @unit  @name (@note)', array('@quantity' => $ing_0_quantity, '@unit' => $this->unit_list[$ing_0_unit]['name'], '@name' => $ing_0_name, '@note' => $ing_0_note)), 'Found ingredient 0.');
    $this->assertRaw(format_string('@quantity @unit @name (@note)', array('@quantity' => $ing_1_quantity, '@unit' => $this->unit_list[$ing_1_unit]['plural'], '@name' => $ing_1_name, '@note' => $ing_1_note)), 'Found ingredient 1.');
    $this->assertRaw(format_string('   @unit  @name (@note)', array('@unit' => $this->unit_list[$ing_2_unit]['name'], '@name' => $ing_2_name, '@note' => $ing_2_note)), 'Found ingredient 2.');
    $this->assertRaw(format_string('@quantity @unit  @name', array('@quantity' => $ing_3_quantity, '@unit' => $this->unit_list[$ing_3_unit]['name'], '@name' => $ing_3_name)), 'Found ingredient 3.');
    $this->assertRaw(format_string('@quantity             @name (@note)', array('@quantity' => $ing_4_quantity, '@name' => $ing_4_name, '@note' => $ing_4_note)), 'Found ingredient 4.');

    // Check for the recipe data on the recipeML export page.
    $this->drupalGet('recipe/export/recipeml/1/' . $yield);
    $this->assertRaw(format_string('<description>@description</description>', array('@description' => $description)), 'Found the recipe description.');
    $this->assertRaw(format_string('<yield><qty>@yield</qty><unit>@yield_unit</unit></yield>', array('@yield' => $yield, '@yield_unit' => $yield_unit)), 'Found the recipe yield and yield unit.');
    $this->assertRaw(format_string('<source>@source</source>', array('@source' => $source)), 'Found the recipe source.');
    $this->assertRaw(format_string('<note>@notes</note>', array('@notes' => $notes)), 'Found the recipe notes.');
    $this->assertRaw(format_string('<directions>@instructions</directions>', array('@instructions' => $instructions)), 'Found the recipe instructions');
    $this->assertRaw(format_string('<preptime type="cooking"><time><qty>@preptime</qty><timeunit>minutes</timeunit></time></preptime>', array('@preptime' => $preptime)), 'Found the recipe prep time.');
    // The recipeML format does not output the cook time.
    // The recipeML format does not output the total time.
    $this->assertRaw(format_string('<ing><amt><qty>@quantity</qty><unit>@unit</unit></amt><item>@name</item><prep>@note</prep></ing>', array('@quantity' => $ing_0_quantity, '@unit' => $this->unit_list[$ing_0_unit]['name'], '@name' => $ing_0_name, '@note' => $ing_0_note)), 'Found ingredient 0.');
    $this->assertRaw(format_string('<ing><amt><qty>@quantity</qty><unit>@unit</unit></amt><item>@name</item><prep>@note</prep></ing>', array('@quantity' => $ing_1_quantity, '@unit' => $this->unit_list[$ing_1_unit]['plural'], '@name' => $ing_1_name, '@note' => $ing_1_note)), 'Found ingredient 1.');
    $this->assertRaw(format_string('<ing><amt><qty>@quantity</qty><unit>@unit</unit></amt><item>@name</item><prep>@note</prep></ing>', array('@quantity' => $ing_2_quantity, '@unit' => $this->unit_list[$ing_2_unit]['name'], '@name' => $ing_2_name, '@note' => $ing_2_note)), 'Found ingredient 2.');
    $this->assertRaw(format_string('<ing><amt><qty>@quantity</qty><unit>@unit</unit></amt><item>@name</item></ing>', array('@quantity' => $ing_3_quantity, '@unit' => $this->unit_list[$ing_3_unit]['name'], '@name' => $ing_3_name, '@note' => $ing_0_note)), 'Found ingredient 3.');
    $this->assertRaw(format_string('<ing><amt><qty>@quantity</qty><unit> </unit></amt><item>@name</item><prep>@note</prep></ing>', array('@quantity' => $ing_4_quantity, '@name' => $ing_4_name, '@note' => $ing_4_note)), 'Found ingredient 4.');

    // Check for the description in the teaser view at /node.
    $this->drupalGet('node');
    $this->assertText($description, 'Found the recipe description.');

    // Check for the altered unit list when editing the node.
    $this->drupalGet('node/1/edit');
    $this->assertFieldByXPath('//option[@value="test_unit"]', NULL, 'Found the altered unit.');
  }

  /**
   * Tests exporting recipes with the multiple export page.
   */
  public function testRecipeMultipleExport() {
    // Create two recipe nodes.
    $node_title_1 = $this->randomName(16);
    $source_1 = $this->randomName(16);
    $yield_1 = 10;
    $yield_unit_1 = $this->randomName(10);
    $description_1 = $this->randomName(32);
    $instructions_1 = $this->randomName(32);
    $notes_1 = $this->randomName(32);
    $preptime_1 = 30;
    $cooktime_1 = 90;
    $quantity_1 = 2;
    $unit_key_1 = 'cup';
    $ingredient_name_1 = $this->randomName(16);
    $ingredient_note_1 = $this->randomName(16);
    $edit = array(
      'type' => 'recipe',
      'title' => $node_title_1,
      'recipe_source' => $source_1,
      'recipe_yield' => $yield_1,
      'recipe_yield_unit' => $yield_unit_1,
      'recipe_description' => array(
        'value' => $description_1,
      ),
      'recipe_instructions' => array(
        'value' => $instructions_1,
      ),
      'recipe_notes' => array(
        'value' => $notes_1,
      ),
      'recipe_preptime' => $preptime_1,
      'recipe_cooktime' => $cooktime_1,
      'recipe_ingredients' => array(
        'ing' => array(
          0 => array(
            'quantity' => $quantity_1,
            'unit_key' => $unit_key_1,
            'name' => $ingredient_name_1,
            'note' => $ingredient_note_1,
            'weight' => 0,
          ),
        ),
      ),
    );
    $this->drupalCreateNode($edit);

    $node_title_2 = $this->randomName(16);
    $source_2 = $this->randomName(16);
    $yield_2 = 10;
    $yield_unit_2 = $this->randomName(10);
    $description_2 = $this->randomName(32);
    $instructions_2 = $this->randomName(32);
    $notes_2 = $this->randomName(32);
    $preptime_2 = 15;
    $cooktime_2 = 45;
    $quantity_2 = 2;
    $unit_key_2 = 'cup';
    $ingredient_name_2 = $this->randomName(16);
    $ingredient_note_2 = $this->randomName(16);
    $edit = array(
      'type' => 'recipe',
      'title' => $node_title_2,
      'recipe_source' => $source_2,
      'recipe_yield' => $yield_2,
      'recipe_yield_unit' => $yield_unit_2,
      'recipe_description' => array(
        'value' => $description_2,
      ),
      'recipe_instructions' => array(
        'value' => $instructions_2,
      ),
      'recipe_notes' => array(
        'value' => $notes_2,
      ),
      'recipe_preptime' => $preptime_2,
      'recipe_cooktime' => $cooktime_2,
      'recipe_ingredients' => array(
        'ing' => array(
          0 => array(
            'quantity' => $quantity_2,
            'unit_key' => $unit_key_2,
            'name' => $ingredient_name_2,
            'note' => $ingredient_note_2,
            'weight' => 0,
          ),
        ),
      ),
    );
    $this->drupalCreateNode($edit);

    // Check for links to all the export formats on the bulk export page.
    $this->drupalGet('admin/structure/recipe');
    $this->assertLink('MasterCook4');
    $this->assertLink('Plain Text');
    $this->assertLink('recipeML');

    // Check for the recipe data on the MasterCook4 bulk export page.
    $this->drupalGet('admin/structure/recipe/export_multi/mastercook4');
    $this->assertRaw($node_title_1);
    // The MasterCook4 format does not output the description.
    $this->assertRaw(format_string('Serving Size  : @yield', array('@yield' => $yield_1)), 'Found the recipe yield.');
    // The MasterCook4 format does not output the yield unit.
    $this->assertRaw(format_string('Recipe By     : @source', array('@source' => $source_1)), 'Found the recipe source.');
    $this->assertRaw($notes_1, 'Found the recipe notes.');
    $this->assertRaw($instructions_1, 'Found the recipe instructions');
    $hours = (int) ($preptime_1 / 60);
    $minutes = $preptime_1 % 60;
    $mastercook_time = $hours . ':' . $minutes;
    $this->assertRaw(format_string('Preparation Time :@time', array('@time' => $mastercook_time)), 'Found the recipe prep time.' . $mastercook_time);
    // The MasterCook4 format does not output the cook time.
    // The MasterCook4 format does not output the total time.
    $this->assertRaw(format_string('@quantity  @unit             @name -- @note', array('@quantity' => $quantity_1, '@unit' => $this->unit_list[$unit_key_1]['abbreviation'], '@name' => $ingredient_name_1, '@note' => $ingredient_note_1)), 'Found ingredient 0.');

    $this->assertRaw($node_title_2);
    // The MasterCook4 format does not output the description.
    $this->assertRaw(format_string('Serving Size  : @yield', array('@yield' => $yield_2)), 'Found the recipe yield.');
    // The MasterCook4 format does not output the yield unit.
    $this->assertRaw(format_string('Recipe By     : @source', array('@source' => $source_2)), 'Found the recipe source.');
    $this->assertRaw($notes_2, 'Found the recipe notes.');
    $this->assertRaw($instructions_2, 'Found the recipe instructions');
    $hours = (int) ($preptime_2 / 60);
    $minutes = $preptime_2 % 60;
    $mastercook_time = $hours . ':' . $minutes;
    $this->assertRaw(format_string('Preparation Time :@time', array('@time' => $mastercook_time)), 'Found the recipe prep time.' . $mastercook_time);
    // The MasterCook4 format does not output the cook time.
    // The MasterCook4 format does not output the total time.
    $this->assertRaw(format_string('@quantity  @unit             @name -- @note', array('@quantity' => $quantity_2, '@unit' => $this->unit_list[$unit_key_2]['abbreviation'], '@name' => $ingredient_name_2, '@note' => $ingredient_note_2)), 'Found ingredient 0.');

    // Check for the recipe data on the plain text export page.
    $this->drupalGet('admin/structure/recipe/export_multi/plaintext');
    $this->assertRaw($node_title_1);
    $this->assertRaw($description_1, 'Found the recipe description.');
    // The plain text format does not output the yield.
    // The plain text format does not output the yield unit.
    // The plain text format does not output the source.
    $this->assertRaw($notes_1, 'Found the recipe notes.');
    $this->assertRaw($instructions_1, 'Found the recipe instructions');
    // The plain text format does not output the prep time.
    // The plain text format does not output the cook time.
    // The plain text format does not output the total time.
    $this->assertRaw(format_string('@quantity @unit @name (@note)', array('@quantity' => $quantity_1, '@unit' => $this->unit_list[$unit_key_1]['abbreviation'], '@name' => $ingredient_name_1, '@note' => $ingredient_note_1)), 'Found ingredient 0.');

    $this->assertRaw($node_title_2);
    $this->assertRaw($description_2, 'Found the recipe description.');
    // The plain text format does not output the yield.
    // The plain text format does not output the yield unit.
    // The plain text format does not output the source.
    $this->assertRaw($notes_2, 'Found the recipe notes.');
    $this->assertRaw($instructions_2, 'Found the recipe instructions');
    // The plain text format does not output the prep time.
    // The plain text format does not output the cook time.
    // The plain text format does not output the total time.
    $this->assertRaw(format_string('@quantity @unit @name (@note)', array('@quantity' => $quantity_2, '@unit' => $this->unit_list[$unit_key_2]['abbreviation'], '@name' => $ingredient_name_2, '@note' => $ingredient_note_2)), 'Found ingredient 0.');

    // Check for the recipe data on the recipeML export page.
    $this->drupalGet('admin/structure/recipe/export_multi/recipeml');
    $this->assertRaw($node_title_1);
    $this->assertRaw(format_string('<description>@description</description>', array('@description' => $description_1)), 'Found the recipe description.');
    $this->assertRaw(format_string('<yield><qty>@yield</qty><unit>@yield_unit</unit></yield>', array('@yield' => $yield_1, '@yield_unit' => $yield_unit_1)), 'Found the recipe yield and yield unit.');
    $this->assertRaw(format_string('<source>@source</source>', array('@source' => $source_1)), 'Found the recipe source.');
    $this->assertRaw(format_string('<note>@notes</note>', array('@notes' => $notes_1)), 'Found the recipe notes.');
    $this->assertRaw(format_string('<directions>@instructions</directions>', array('@instructions' => $instructions_1)), 'Found the recipe instructions');
    $this->assertRaw(format_string('<preptime type="cooking"><time><qty>@preptime</qty><timeunit>minutes</timeunit></time></preptime>', array('@preptime' => $preptime_1)), 'Found the recipe prep time.');
    // The recipeML format does not output the cook time.
    // The recipeML format does not output the total time.
    $this->assertRaw(format_string('<ing><amt><qty>@quantity</qty><unit>@unit</unit></amt><item>@name</item><prep>@note</prep></ing>', array('@quantity' => $quantity_1, '@unit' => $this->unit_list[$unit_key_1]['abbreviation'], '@name' => $ingredient_name_1, '@note' => $ingredient_note_1)), 'Found ingredient 0.');

    $this->assertRaw($node_title_2);
    $this->assertRaw(format_string('<description>@description</description>', array('@description' => $description_2)), 'Found the recipe description.');
    $this->assertRaw(format_string('<yield><qty>@yield</qty><unit>@yield_unit</unit></yield>', array('@yield' => $yield_2, '@yield_unit' => $yield_unit_2)), 'Found the recipe yield and yield unit.');
    $this->assertRaw(format_string('<source>@source</source>', array('@source' => $source_2)), 'Found the recipe source.');
    $this->assertRaw(format_string('<note>@notes</note>', array('@notes' => $notes_2)), 'Found the recipe notes.');
    $this->assertRaw(format_string('<directions>@instructions</directions>', array('@instructions' => $instructions_2)), 'Found the recipe instructions');
    $this->assertRaw(format_string('<preptime type="cooking"><time><qty>@preptime</qty><timeunit>minutes</timeunit></time></preptime>', array('@preptime' => $preptime_2)), 'Found the recipe prep time.');
    // The recipeML format does not output the cook time.
    // The recipeML format does not output the total time.
    $this->assertRaw(format_string('<ing><amt><qty>@quantity</qty><unit>@unit</unit></amt><item>@name</item><prep>@note</prep></ing>', array('@quantity' => $quantity_2, '@unit' => $this->unit_list[$unit_key_2]['abbreviation'], '@name' => $ingredient_name_2, '@note' => $ingredient_note_2)), 'Found ingredient 0.');
  }

  /**
   * Format recipe times for display.
   *
   * @todo This function and the code its copied from in theme_recipe_summary()
   * need to be replaced with an equivalent function in recipe.module.
   */
  protected function formatTime($time) {
    $_o_minutes = $time;
    $_hours = floor($_o_minutes / 60);
    $_minutes = $_o_minutes - ($_hours * 60);
    $_text = '';
    if ($_hours > 0) {
      $_text = format_plural($_hours, '1 hour', '@count hours');
    }
    if ($_minutes > 0) {
      if (strlen($_text) > 0) {
        $_text .= ', ';
      }
      $_text .= format_plural($_minutes, '1 minute', '@count minutes');
    }
    return $_text;
  }

  /**
   * Format recipe times for display on the HTML export.
   *
   * @todo This horrible time display logic needs to be eliminated.
   */
  protected function formatHTMLTime($time) {
    if ($time < 60) {
      return format_plural($time, '1 minute', '@count minutes');
    }
    elseif ($time % 60 == 0) {
      return format_plural($time / 60, '1 hour', '@count hours');
    }
    else {
      return t('!time hours', array('!time' => recipe_ingredient_quantity_from_decimal($time / 60)));
    }
  }
}

/**
 * Tests the custom yield form in a recipe node.
 */
class RecipeYieldFormTestCase extends RecipeWebTestCase {
  public static function getInfo() {
    return array(
      'name' => 'Recipe yield form',
      'description' => 'Test the custom yield form in a recipe node.',
      'group' => 'Recipe',
    );
  }

  /**
   * Tests the custom yield form functionality.
   *
   * This test only verifies that the form is capable of altering the yield and
   * ingredient quantities.  Issues with values returned by ingredient quantity
   * conversion can be tested in RecipeUnitTestCase.
   */
  public function testRecipeYieldForm() {
    // Create a recipe node.
    $node_title = $this->randomName(16);
    $yield = 10;
    $quantity = 2;
    $unit_key = 'cup';
    $ingredient_name = $this->randomName(16);
    $edit = array(
      'type' => 'recipe',
      'title' => $node_title,
      'recipe_source' => '',
      'recipe_yield' => $yield,
      'recipe_yield_unit' => '',
      'recipe_description' => array(
        'value' => '',
      ),
      'recipe_instructions' => array(
        'value' => '',
      ),
      'recipe_notes' => array(
        'value' => '',
      ),
      'recipe_preptime' => 1,
      'recipe_cooktime' => 1,
      'recipe_ingredients' => array(
        'ing' => array(
          0 => array(
            'quantity' => $quantity,
            'unit_key' => $unit_key,
            'name' => $ingredient_name,
            'note' => '',
            'weight' => 0,
          ),
        ),
      ),
    );
    $this->drupalCreateNode($edit);

    // Go to the recipe node and verify the yield and quantity values.
    $this->drupalGet('node/1');
    $this->assertFieldById('edit-custom-yield', $yield, 'Found the recipe yield in the custom yield form.');
    $this->assertText(format_string('@quantity @unit', array('@quantity' => $quantity, '@unit' => $this->unit_list[$unit_key]['abbreviation'])), 'Found the recipe quantity.');

    // Use the custom yield form to halve the yield and check for new values.
    $this->drupalPost(NULL, NULL, 'Halve');
    $this->assertFieldById('edit-custom-yield', $yield / 2, 'Found the halved recipe yield in the custom yield form.');
    $this->assertText(format_string('@quantity @unit', array('@quantity' => $quantity / 2, '@unit' => $this->unit_list[$unit_key]['abbreviation'])), 'Found the halved recipe quantity.');

    // Use the custom yield form to reset the values.
    $this->drupalPost(NULL, NULL, 'Reset');
    $this->assertFieldById('edit-custom-yield', $yield, 'Found the recipe yield in the custom yield form.');
    $this->assertText(format_string('@quantity @unit', array('@quantity' => $quantity, '@unit' => $this->unit_list[$unit_key]['abbreviation'])), 'Found the recipe quantity.');

    // Use the custom yield form to double the yield and check for new values.
    $this->drupalPost(NULL, NULL, 'Double');
    $this->assertFieldById('edit-custom-yield', $yield * 2, 'Found the doubled recipe yield in the custom yield form.');
    $this->assertText(format_string('@quantity @unit', array('@quantity' => $quantity * 2, '@unit' => $this->unit_list[$unit_key]['abbreviation'])), 'Found the doubled recipe quantity.');

    // Use the custom yield form to triple the yield and check for new values.
    $edit = array('custom_yield' => $yield * 3);
    $this->drupalPost(NULL, $edit, 'Change');
    $this->assertFieldById('edit-custom-yield', $yield * 3, 'Found the tripled recipe yield in the custom yield form.');
    $this->assertText(format_string('@quantity @unit', array('@quantity' => $quantity * 3, '@unit' => $this->unit_list[$unit_key]['abbreviation'])), 'Found the tripled recipe quantity.');
  }
}

/**
 * Tests the Recipe module landing page at /recipe.
 */
class RecipeLandingPageTestCase extends RecipeWebTestCase {
  public static function getInfo() {
    return array(
      'name' => 'Recipe landing page',
      'description' => 'Test the content on the Recipe module landing page.',
      'group' => 'Recipe',
    );
  }

  /**
   * Tests the content displayed on the Recipe module landing page.
   */
  public function testRecipeLandingPage() {
    // While logged in as admin user, check for the "Add a new recipe" link.
    $this->drupalGet('recipe');
    $this->assertLink('Add a new recipe', 0);
    // Logout and check that the add recipe link is inaccessible.
    $this->drupalLogout();
    $this->drupalGet('recipe');
    $this->assertNoLink('Add a new recipe');
    $this->drupalLogin($this->admin_user);

    // Check for the Recent Recipe (Latest recipes) box.
    $this->drupalGet('recipe');
    $this->assertText('Latest recipes');

    // Create a recipe node.
    $node_title = $this->randomName(16);
    $edit = array(
      'type' => 'recipe',
      'title' => $node_title,
      'recipe_source' => '',
      'recipe_yield' => 1,
      'recipe_yield_unit' => '',
      'recipe_description' => array(
        'value' => '',
      ),
      'recipe_instructions' => array(
        'value' => '',
      ),
      'recipe_notes' => array(
        'value' => '',
      ),
      'recipe_preptime' => 1,
      'recipe_cooktime' => 1,
      'recipe_ingredients' => array(
        'ing' => array(),
      ),
    );
    $this->drupalCreateNode($edit);

    // Check that the recipe title is displayed.
    $this->drupalGet('recipe');
    $this->assertLink($node_title, 0);

    // Change the title of the box and the number of node titles displayed.
    $recent_recipe_title = $this->randomName(16);
    $edit = array(
      'recipe_recent_box_title' => $recent_recipe_title,
      'recipe_recent_display' => 0,
    );
    $this->drupalPost('admin/config/system/recipe', $edit, t('Save configuration'));

    // Check that the recipe title is not displayed.
    $this->drupalGet('recipe');
    $this->assertText($recent_recipe_title);
    $this->assertNoLink($node_title);

    // Disable the Recent Recipe box.
    $edit = array(
      'recipe_recent_box_enable' => FALSE,
    );
    $this->drupalPost('admin/config/system/recipe', $edit, t('Save configuration'));

    // Check that the Recent Recipe box is disabled.
    $this->drupalGet('recipe');
    $this->assertNoText($recent_recipe_title);
    $this->assertNoLink($node_title);
  }
}

/**
 * Tests display of nodes in recipe lists for node access.
 */
class RecipeNodeAccessTestCase extends DrupalWebTestCase {
  protected $admin_user;
  protected $node_title;

  public static function getInfo() {
    return array(
      'name' => 'Recipe node access',
      'description' => 'Tests display of nodes in recipe lists for node access.',
      'group' => 'Recipe',
    );
  }

  public function setUp() {
    // Enable modules required for testing.
    parent::setUp(array('recipe', 'node_access_test'));

    // Create and log in the admin user with Recipe content permissions.
    $this->admin_user = $this->drupalCreateUser(array('create recipe content', 'edit own recipe content', 'administer blocks'));
    $this->drupalLogin($this->admin_user);

    // Set the variable to enable private nodes with node_access_test.
    node_access_rebuild();
    variable_set('node_access_test_private', TRUE);

    // Create a test recipe node.
    $this->node_title = $this->randomName(16);
    $edit = array(
      'title' => $this->node_title,
      'recipe_description[value]' => $this->randomName(16),
      'recipe_yield' => 1,
      'private' => TRUE,
    );
    $this->drupalPost('node/add/recipe', $edit, 'Save');

    // Enable the Newest Recipes and Recipe Summary blocks.
    $edit = array(
      "blocks[recipe_recent][region]" => 'sidebar_first',
    );
    $this->drupalPost('admin/structure/block', $edit, t('Save blocks'));
  }

  /**
   * Tests node_access for nodes displayed in recipe lists.
   */
  public function testRecentRecipeBoxNodeAccess() {
    // Logout and assert that the anonymous user can't access the node.
    $this->drupalLogout();
    $this->drupalGet('node/1');
    $this->assertResponse(403);
    // Assert that a link to the test recipe can't be seen at /recipe.
    $this->drupalGet('recipe');
    $this->assertNoLink($this->node_title);

    // Log in as the admin_user and set the recipe node as public.
    $this->drupalLogin($this->admin_user);
    $edit = array(
      'private' => FALSE,
    );
    $this->drupalPost('node/1/edit', $edit, 'Save');

    // Logout and assert that the anonymous user can access the node.
    $this->drupalLogout();
    $this->drupalGet('node/1');
    $this->assertResponse(200);
    // Logout and assert that two links to the test recipe can be seen at
    // /recipe. One should be from the /recipe page Recent Recipes box and the
    // other should be from the Latest Recipes block.
    $this->drupalGet('recipe');
    $this->assertLink($this->node_title, 0);
    $this->assertLink($this->node_title, 1);
  }
}

/**
 * Tests the single and multiple recipe import forms.
 */
class RecipeImportFormsTestCase extends RecipeWebTestCase {
  public static function getInfo() {
    return array(
      'name' => 'Recipe import forms',
      'description' => 'Test the single and multiple recipe import forms',
      'group' => 'Recipe',
    );
  }

  /**
   * Test import a recipe in plain text format with the single import form.
   */
  public function testPlainTextSingleImport() {
    // Enter a recipe into the import form and preview it.
    $edit = array(
      'recipe_format' => 'recipe_plaintext_import',
      'recipe_import_text' => 'Salt water

Ingredients:
2 c water (cold)
1 T salt

Instructions:
Combine water and salt in a glass.

Stir.

Description:
Basic salt water.

Notes:
Do not consume!
',
    );
    $this->drupalPost('node/add/recipe/import', $edit, 'Preview');
    $this->assertText('Salt water');
    $this->assertText('2 c', 'Found ingredent 0 quantity and unit.');
    $this->assertText('water (cold)', 'Found ingredient 0 name and note.');
    $this->assertText('1 T', 'Found ingredient 1 quantity and unit.');
    $this->assertText('salt', 'Found ingredient 1 name.');
    $this->assertText('Instructions:
Combine water and salt in a glass.

Stir.

Description:
Basic salt water.

Notes:
Do not consume!', 'Found recipe instructions, description, and notes.');

    // Import the recipe into a node.
    $this->drupalPost('node/add/recipe/import', $edit, 'Import');
    $this->drupalGet('node/1');
    $this->assertText('Salt water');
    $this->assertText('2 c', 'Found ingredent 0 quantity and unit.');
    $this->assertText('water (cold)', 'Found ingredient 0 name and note.');
    $this->assertText('1 T', 'Found ingredient 1 quantity and unit.');
    $this->assertText('salt', 'Found ingredient 1 name.');
    $this->assertText('Combine water and salt in a glass.', 'Found the first instruction.');
    $this->assertText('Stir.', 'Found the second instruction.');
    $this->assertText('Basic salt water.', 'Found the recipe description.');
    $this->assertText('Do not consume!', 'Found the recipe notes.');
  }

  /**
   * Test import a recipe in MasterCook4 format with the single import form.
   */
  public function testMasterCook4SingleImport() {
    // Enter a recipe into the import form and preview it.
    $edit = array(
      'recipe_format' => 'recipe_mastercook4_import_single',
      'recipe_import_text' => '* Exported from MasterCook *

                     Salt water

Recipe By     : John Doe
Serving Size  : 1    Preparation Time : 0:05
Categories    :
  Amount  Measure       Ingredient -- Preparation Method
--------  ------------  --------------------------------
       2          cups  water -- cold
       1    tablespoon  salt

Combine water and salt in a glass.

Stir.

                                    - - - - - - - - - - - - - - - - - - -

NOTES : Do not consume!',
    );
    $this->drupalPost('node/add/recipe/import', $edit, 'Preview');
    $this->assertText('Salt water');
    $this->assertText('2 c', 'Found ingredent 0 quantity and unit.');
    $this->assertText('water (cold)', 'Found ingredient 0 name and note.');
    $this->assertText('1 T', 'Found ingredient 1 quantity and unit.');
    $this->assertText('salt', 'Found ingredient 1 name.');
    $this->assertText('Combine water and salt in a glass.

Stir.', 'Found recipe instructions.');
    $this->assertText('Do not consume!', 'Found recipe notes.');

    // Import the recipe into a node.
    $this->drupalPost('node/add/recipe/import', $edit, 'Import');
    $this->drupalGet('node/1');
    $this->assertText('Salt water');
    $this->assertText('2 c', 'Found ingredent 0 quantity and unit.');
    $this->assertText('water (cold)', 'Found ingredient 0 name and note.');
    $this->assertText('1 T', 'Found ingredient 1 quantity and unit.');
    $this->assertText('salt', 'Found ingredient 1 name.');
    $this->assertText('Combine water and salt in a glass.', 'Found the first instruction.');
    $this->assertText('Stir.', 'Found the second instruction.');
    $this->assertText('Do not consume!', 'Found the recipe notes.');
  }

  /**
   * Test import recipes in MasterCook4 format with the multiple import form.
   */
  public function testMasterCook4MultipleImport() {
    // Check for the MasterCook4 form link on the bulk import page.
    $this->drupalGet('admin/structure/recipe/import_multi');
    $this->assertLink('MasterCook4', 0);

    // Import the MasterCook4 test file using the multiple import form.
    $edit = array(
      'files[recipe_import_file]' => drupal_get_path('module', 'recipe') . '/tests/recipe_mastercook4_test.mxp',
    );
    $this->drupalPost('admin/structure/recipe/import_multi/mastercook4', $edit, t('Import'));
    $this->assertText(t('The attached file was successfully uploaded'));

    // Verify that the first recipe was imported correctly.
    $this->drupalGet('node/1');
    $this->assertText('Salt water');
    $this->assertText('John Doe', 'Found the recipe source.');
    $this->assertText('2 c', 'Found ingredent 0 quantity and unit.');
    $this->assertText('water (cold)', 'Found ingredient 0 name and note.');
    $this->assertText('1 T', 'Found ingredient 1 quantity and unit.');
    $this->assertText('salt', 'Found ingredient 1 name.');
    $this->assertText('Combine water and salt in a glass.', 'Found the first instruction.');
    $this->assertText('Stir.', 'Found the second instruction.');
    $this->assertText('Do not consume!', 'Found the recipe notes.');

    // Verify that the second recipe was imported correctly.
    $this->drupalGet('node/2');
    $this->assertText('Hard-boiled eggs');
    $this->assertText('Jane Doe', 'Found the recipe source.');
    $this->assertText('2 q', 'Found ingredent 0 quantity and unit.');
    $this->assertText('water (hot)', 'Found ingredient 0 name and note.');
    $this->assertRaw('<div class="quantity-unit" property="schema:amount"> 4 </div>', 'Found ingredient 1 quantity with no unit.');
    $this->assertText('eggs', 'Found ingredient 1 name.');
    $this->assertText('Boil the water.', 'Found the first instruction.');
    $this->assertText('Put the eggs in the boiling water for 5 minutes.', 'Found the second instruction.');
    $this->assertText('Allow the eggs to cool.', 'Found the third instruction.');
    $this->assertText('Break the shells and consume.', 'Found the fourth instruction.');
  }

  /**
   * Test import recipes in recipeML format with the multiple import form.
   */
  public function testRecipeMLMultipleImport() {
    // Check for the recipeML form link on the bulk import page.
    $this->drupalGet('admin/structure/recipe/import_multi');
    $this->assertLink('recipeML', 0);

    // Import the recipeML test file using the multiple import form.
    $edit = array(
      'files[recipe_import_file]' => drupal_get_path('module', 'recipe') . '/tests/recipe_recipeml_test.xml',
    );
    $this->drupalPost('admin/structure/recipe/import_multi/recipeml', $edit, t('Import'));
    $this->assertText(t('The attached file was successfully uploaded'));

    // Verify that the first recipe was imported correctly.
    $this->drupalGet('node/1');
    $this->assertText('Salt water');
    $this->assertFieldById('edit-custom-yield', 1, 'Found the recipe yield in the custom yield form.');
    $this->assertText('Servings', 'Found the recipe yield unit.');
    $this->assertText('John Doe', 'Found the recipe source.');
    $this->assertText('2 c', 'Found ingredent 0 quantity and unit.');
    $this->assertText('water (cold)', 'Found ingredient 0 name and note.');
    $this->assertText('1 T', 'Found ingredient 1 quantity and unit.');
    $this->assertText('salt', 'Found ingredient 1 name.');
    $this->assertText('Combine water and salt in a glass.', 'Found the first instruction.');
    $this->assertText('Stir.', 'Found the second instruction.');
    $this->assertText('Do not consume!', 'Found the recipe notes.');

    // Verify that the second recipe was imported correctly.
    $this->drupalGet('node/2');
    $this->assertText('Hard-boiled eggs');
    $this->assertFieldById('edit-custom-yield', 2, 'Found the recipe yield in the custom yield form.');
    $this->assertText('Servings', 'Found the recipe yield unit.');
    $this->assertText('Jane Doe', 'Found the recipe source.');
    $this->assertText('2 q', 'Found ingredent 0 quantity and unit.');
    $this->assertText('water (hot)', 'Found ingredient 0 name and note.');
    $this->assertRaw('<div class="quantity-unit" property="schema:amount"> 4 </div>', 'Found ingredient 1 quantity with no unit.');
    $this->assertText('eggs', 'Found ingredient 1 name.');
    $this->assertText('Boil the water.', 'Found the first instruction.');
    $this->assertText('Put the eggs in the boiling water for 5 minutes.', 'Found the second instruction.');
    $this->assertText('Allow the eggs to cool.', 'Found the third instruction.');
    $this->assertText('Break the shells and consume.', 'Found the fourth instruction.');
  }
}

/**
 * Tests isolated Recipe module functions.
 *
 * @see DrupalUnitTestCase
 */
class RecipeUnitTestCase extends DrupalUnitTestCase {

  public static function getInfo() {
    return array(
      'name' => 'Recipe unit tests',
      'description' => 'Test that Recipe functions work properly.',
      'group' => 'Recipe',
    );
  }

  function setUp() {
    drupal_load('module', 'recipe');
    parent::setUp();
  }

  /**
   * Test ingredient quantity conversion functions.
   */
  public function testIngredientQuantityConversion() {
    $quantities = array(
      // Test a couple of whole numbers.
      '1',
      '10',
      // Test a couple of mixed numbers.
      '1 1/2',
      '10 1/2',
      // Test the fractions which convert to repeating decimals that are
      // converted by recipe_ingredient_quantity_from_decimal().
      '1/3',
      '2/3',
      '1/6',
      '5/6',
      '1/9',
      '2/9',
      '4/9',
      '5/9',
      '7/9',
      '8/9',
      '1/12',
      '5/12',
      '7/12',
      '11/12',
    );

    foreach ($quantities as $quantity) {
      // Convert the fraction quantity to a decimal.
      $decimal = recipe_ingredient_quantity_from_fraction($quantity);
      // Convert the decimal quantity back to a fraction string.
      $fraction = recipe_ingredient_quantity_from_decimal($decimal);
      // Replace the '&frasl;' in the fraction string with '/'.
      $fraction = str_replace('&frasl;', '/', $fraction);
      // Verify the fraction result is the same as the original quantity.
      $this->assertEqual($quantity, $fraction);
    }
  }
}
